<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nicolas Brosse">
<meta name="dcterms.date" content="2025-06-30">
<meta name="description" content="Integrating Langfuse for LLM observability in a FastHTML chatbot application.">

<title>LLM Observability with Langfuse and a FastHTML Chatbot - Part 1 – Nicolas’ Notebook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-313591559204ad6a7884cc02194e8f50.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Nicolas’ Notebook</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/nbrosse"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/nicolas-brosse-984685a0/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">LLM Observability with Langfuse and a FastHTML Chatbot - Part 1</h1>
                  <div>
        <div class="description">
          Integrating Langfuse for LLM observability in a FastHTML chatbot application.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">LLM</div>
                <div class="quarto-category">python</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Nicolas Brosse </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 30, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sec-langfuse" id="toc-sec-langfuse" class="nav-link active" data-scroll-target="#sec-langfuse">Presentation of Langfuse</a></li>
  <li><a href="#a-fasthtml-chatbot-with-langfuse-and-google-gemini" id="toc-a-fasthtml-chatbot-with-langfuse-and-google-gemini" class="nav-link" data-scroll-target="#a-fasthtml-chatbot-with-langfuse-and-google-gemini">A FastHTML Chatbot with Langfuse and Google Gemini</a>
  <ul class="collapse">
  <li><a href="#why-not-use-streamlit" id="toc-why-not-use-streamlit" class="nav-link" data-scroll-target="#why-not-use-streamlit">Why not use Streamlit ?</a></li>
  <li><a href="#why-fasthtml" id="toc-why-fasthtml" class="nav-link" data-scroll-target="#why-fasthtml">Why FastHTML?</a></li>
  <li><a href="#building-a-chatbot-with-fasthtml-google-gemini-and-langfuse" id="toc-building-a-chatbot-with-fasthtml-google-gemini-and-langfuse" class="nav-link" data-scroll-target="#building-a-chatbot-with-fasthtml-google-gemini-and-langfuse">Building a Chatbot with FastHTML, Google Gemini, and Langfuse</a>
  <ul class="collapse">
  <li><a href="#overview-of-functionality" id="toc-overview-of-functionality" class="nav-link" data-scroll-target="#overview-of-functionality">Overview of Functionality</a></li>
  <li><a href="#initial-setup-and-configuration" id="toc-initial-setup-and-configuration" class="nav-link" data-scroll-target="#initial-setup-and-configuration">Initial Setup and Configuration</a></li>
  <li><a href="#markdown-rendering-helper" id="toc-markdown-rendering-helper" class="nav-link" data-scroll-target="#markdown-rendering-helper">Markdown Rendering Helper</a></li>
  <li><a href="#the-sessionsmanager-class" id="toc-the-sessionsmanager-class" class="nav-link" data-scroll-target="#the-sessionsmanager-class">The <code>SessionsManager</code> Class</a></li>
  <li><a href="#application-initialization-ui-components-and-main-page" id="toc-application-initialization-ui-components-and-main-page" class="nav-link" data-scroll-target="#application-initialization-ui-components-and-main-page">Application Initialization, UI Components and Main Page</a></li>
  <li><a href="#websocket" id="toc-websocket" class="nav-link" data-scroll-target="#websocket">WebSocket</a></li>
  <li><a href="#supporting-http-endpoints" id="toc-supporting-http-endpoints" class="nav-link" data-scroll-target="#supporting-http-endpoints">Supporting HTTP Endpoints</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#run-the-chatbot-application" id="toc-run-the-chatbot-application" class="nav-link" data-scroll-target="#run-the-chatbot-application">Run the Chatbot Application</a></li>
  <li><a href="#run-the-chatbot-application-1" id="toc-run-the-chatbot-application-1" class="nav-link" data-scroll-target="#run-the-chatbot-application-1">Run the Chatbot Application</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#sec-appendix-rendering-markdown" id="toc-sec-appendix-rendering-markdown" class="nav-link" data-scroll-target="#sec-appendix-rendering-markdown">Appendix: Rendering Markdown in FastHTML</a>
  <ul class="collapse">
  <li><a href="#approach-1-custom-javascript-with-marked.js" id="toc-approach-1-custom-javascript-with-marked.js" class="nav-link" data-scroll-target="#approach-1-custom-javascript-with-marked.js">Approach 1: Custom JavaScript with <code>marked.js</code></a></li>
  <li><a href="#approach-2-fasthtml-built-in-components" id="toc-approach-2-fasthtml-built-in-components" class="nav-link" data-scroll-target="#approach-2-fasthtml-built-in-components">Approach 2: FastHTML Built-in Components</a></li>
  <li><a href="#approach-3-using-the-zero-md-web-component" id="toc-approach-3-using-the-zero-md-web-component" class="nav-link" data-scroll-target="#approach-3-using-the-zero-md-web-component">Approach 3: Using the <code>zero-md</code> Web Component</a></li>
  <li><a href="#comparison-of-approaches" id="toc-comparison-of-approaches" class="nav-link" data-scroll-target="#comparison-of-approaches">Comparison of Approaches</a>
  <ul class="collapse">
  <li><a href="#summary-table" id="toc-summary-table" class="nav-link" data-scroll-target="#summary-table">Summary Table</a></li>
  <li><a href="#key-differences-and-recommendations" id="toc-key-differences-and-recommendations" class="nav-link" data-scroll-target="#key-differences-and-recommendations">Key Differences and Recommendations</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>As Large Language Models (LLMs) become increasingly integrated into real-world applications, understanding and monitoring their behavior is essential. LLM observability—the practice of tracing, logging, and analyzing model interactions—enables developers to diagnose issues, optimize performance, and ensure responsible AI usage.</p>
<p>This blog post is the first in a series presenting a proof of concept for implementing LLM observability using Langfuse, an open-source observability platform, together with a responsive chatbot built with FastHTML. The goal is to showcase practical techniques for capturing and visualizing LLM interactions, providing valuable insights for building more reliable and transparent AI systems.</p>
<p>In this blog post, I demonstrate how to integrate Langfuse into a FastHTML chatbot application for enhanced observability.</p>
<p>The associated code is available on <a href="https://github.com/nbrosse/llm-observability">llm-observability</a>.</p>
<section id="sec-langfuse" class="level1">
<h1>Presentation of Langfuse</h1>
<p>For the foundational observability layer, I selected <strong>Langfuse</strong>. Langfuse is an open-source platform specifically designed for LLM applications, offering tools to trace, debug, and analyze LLM interactions. Its capabilities allow for detailed tracking of requests, responses, latencies, token usage, and other relevant metrics. We chose Langfuse due to its open-source nature, dedicated focus on LLMs, and its promise of comprehensive tracing features. We refer to the official <a href="https://langfuse.com/docs">Langfuse documentation</a> for more details on its features and setup. It provides features for tracing, prompt management, and evaluations:</p>
<ul>
<li><strong>Tracing:</strong> Log traces with lowest level transparency to understand cost and latency. Traces include all LLM and non-LLM calls, including retrieval, embedding, API calls, and more. It supports tracking multi-turn conversations as sessions and user tracking. Traces can be captured via native SDKs for Python/JS, 50+ library/framework integrations, OpenTelemetry, or via an LLM Gateway such as LiteLLM.</li>
<li><strong>Prompt Management:</strong> Manage, version, and optimize prompts throughout the development lifecycle. Test prompts interactively in the LLM Playground, and run prompt experiments against datasets to test new prompt versions directly within Langfuse.</li>
<li><strong>Evaluations:</strong> Measure output quality and monitor production health. Langfuse provides flexible evaluation tools, including LLM-as-a-judge, user feedback, manual labeling, or custom methods. Evaluations can be run on production traces and offline datasets for systematic testing.</li>
</ul>
<p>Langfuse is open, self-hostable, and extensible. For testing purposes, it is recommended to run Langfuse locally. It can be easily set up using Docker Compose, which simplifies the deployment process and allows for quick iterations during development. The guide from the <a href="https://langfuse.com/self-hosting/docker-compose">Langfuse documentation</a> enables users to quickly get started with a local instance. The setup involves pulling the Docker image, configuring environment variables, and running the container. This approach provides a convenient way to experiment with Langfuse’s features without needing a cloud deployment, making it ideal for development and testing scenarios.</p>
</section>
<section id="a-fasthtml-chatbot-with-langfuse-and-google-gemini" class="level1">
<h1>A FastHTML Chatbot with Langfuse and Google Gemini</h1>
<section id="why-not-use-streamlit" class="level2">
<h2 class="anchored" data-anchor-id="why-not-use-streamlit">Why not use Streamlit ?</h2>
<p>My initial thought was to utilize Streamlit, a popular Python library known for its ease of use in creating web applications rapidly. Streamlit is indeed very accessible for quick prototyping. However, Streamlit often relies on a full-page reload or significant re-rendering of components upon user interaction. For a dynamic, conversational interface like a chatbot, this behavior seems unnatural and can lead to a clunky user experience.</p>
<p>Below in <a href="#lst-python-streamlit-app" class="quarto-xref">Listing&nbsp;1</a>, we provide the <a href="https://docs.streamlit.io/develop/tutorials/chat-and-llm-apps/build-conversational-apps">official example</a> of a Streamlit chatbot application.</p>
<div id="lst-python-streamlit-app" class="python listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-python-streamlit-app-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;1: Example of a Streamlit chatbot application
</figcaption>
<div aria-describedby="lst-python-streamlit-app-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="sourceCode" id="lst-python-streamlit-app"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-python-streamlit-app-1"><a href="#lst-python-streamlit-app-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="lst-python-streamlit-app-2"><a href="#lst-python-streamlit-app-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-python-streamlit-app-3"><a href="#lst-python-streamlit-app-3" aria-hidden="true" tabindex="-1"></a>st.title(<span class="st">"Echo Bot"</span>)</span>
<span id="lst-python-streamlit-app-4"><a href="#lst-python-streamlit-app-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-python-streamlit-app-5"><a href="#lst-python-streamlit-app-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize chat history</span></span>
<span id="lst-python-streamlit-app-6"><a href="#lst-python-streamlit-app-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"messages"</span> <span class="kw">not</span> <span class="kw">in</span> st.session_state:</span>
<span id="lst-python-streamlit-app-7"><a href="#lst-python-streamlit-app-7" aria-hidden="true" tabindex="-1"></a>    st.session_state.messages <span class="op">=</span> []</span>
<span id="lst-python-streamlit-app-8"><a href="#lst-python-streamlit-app-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-python-streamlit-app-9"><a href="#lst-python-streamlit-app-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display chat messages from history on app rerun</span></span>
<span id="lst-python-streamlit-app-10"><a href="#lst-python-streamlit-app-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> message <span class="kw">in</span> st.session_state.messages:</span>
<span id="lst-python-streamlit-app-11"><a href="#lst-python-streamlit-app-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> st.chat_message(message[<span class="st">"role"</span>]):</span>
<span id="lst-python-streamlit-app-12"><a href="#lst-python-streamlit-app-12" aria-hidden="true" tabindex="-1"></a>        st.markdown(message[<span class="st">"content"</span>])</span>
<span id="lst-python-streamlit-app-13"><a href="#lst-python-streamlit-app-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-python-streamlit-app-14"><a href="#lst-python-streamlit-app-14" aria-hidden="true" tabindex="-1"></a><span class="co"># React to user input</span></span>
<span id="lst-python-streamlit-app-15"><a href="#lst-python-streamlit-app-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> prompt <span class="op">:=</span> st.chat_input(<span class="st">"What is up?"</span>):</span>
<span id="lst-python-streamlit-app-16"><a href="#lst-python-streamlit-app-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display user message in chat message container</span></span>
<span id="lst-python-streamlit-app-17"><a href="#lst-python-streamlit-app-17" aria-hidden="true" tabindex="-1"></a>    st.chat_message(<span class="st">"user"</span>).markdown(prompt)</span>
<span id="lst-python-streamlit-app-18"><a href="#lst-python-streamlit-app-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add user message to chat history</span></span>
<span id="lst-python-streamlit-app-19"><a href="#lst-python-streamlit-app-19" aria-hidden="true" tabindex="-1"></a>    st.session_state.messages.append({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt})</span>
<span id="lst-python-streamlit-app-20"><a href="#lst-python-streamlit-app-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-python-streamlit-app-21"><a href="#lst-python-streamlit-app-21" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> <span class="ss">f"Echo: </span><span class="sc">{</span>prompt<span class="sc">}</span><span class="ss">"</span></span>
<span id="lst-python-streamlit-app-22"><a href="#lst-python-streamlit-app-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display assistant response in chat message container</span></span>
<span id="lst-python-streamlit-app-23"><a href="#lst-python-streamlit-app-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> st.chat_message(<span class="st">"assistant"</span>):</span>
<span id="lst-python-streamlit-app-24"><a href="#lst-python-streamlit-app-24" aria-hidden="true" tabindex="-1"></a>        st.markdown(response)</span>
<span id="lst-python-streamlit-app-25"><a href="#lst-python-streamlit-app-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add assistant response to chat history</span></span>
<span id="lst-python-streamlit-app-26"><a href="#lst-python-streamlit-app-26" aria-hidden="true" tabindex="-1"></a>    st.session_state.messages.append({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: response})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</figure>
</div>
<p>Streamlit re-runs the entire Python script from top to bottom every time the user interacts with the app (e.g., submits a message, clicks a button) or when the app reloads. To keep data between these reruns, Streamlit uses <code>st.session_state</code>. Without it, variables would reset on each rerun. Which means that at each reload, the entire chat history is re-rendered from the <code>st.session_state.messages</code> list. This can lead to a less responsive user experience, especially in a chatbot context where users expect real-time interaction. It feels counterintuitive to have to manage the chat history in a session state variable, which is not a natural way to handle dynamic content updates.</p>
</section>
<section id="why-fasthtml" class="level2">
<h2 class="anchored" data-anchor-id="why-fasthtml">Why FastHTML?</h2>
<p>Consequently, I shifted my focus to <strong>FastHTML</strong>. <a href="https://www.fastht.ml/docs">FastHTML</a> is a newer approach/API developed by <a href="https://www.answer.ai/posts/2024-08-03-fasthtml.html">Answer AI</a> designed for building dynamic web interfaces with potentially more granular control over updates, avoiding full-page reloads. I found a pre-existing, <a href="https://www.fastht.ml/docs/tutorials/by_example.html#full-example-3---chatbot-example-with-daisyui-components">fully-functional chatbot example</a> built with FastHTML. This <a href="https://github.com/AnswerDotAI/fasthtml-example/tree/main/02_chatbot">example</a> provided with additional extensions is a great starting point for building a responsive chatbot application. It uses FastHTML’s capabilities to create a chat interface that updates dynamically without reloading the entire page, providing a more fluid user experience.</p>
</section>
<section id="building-a-chatbot-with-fasthtml-google-gemini-and-langfuse" class="level2">
<h2 class="anchored" data-anchor-id="building-a-chatbot-with-fasthtml-google-gemini-and-langfuse">Building a Chatbot with FastHTML, Google Gemini, and Langfuse</h2>
<p>Below is a step by step detailed analysis of the fasthtml app. The application is built using the <strong>FastHTML</strong> web framework and leverages <strong>Google’s Gemini</strong> for its conversational AI capabilities. For observability and user feedback, it integrates with <strong>Langfuse</strong>.</p>
<section id="overview-of-functionality" class="level3">
<h3 class="anchored" data-anchor-id="overview-of-functionality">Overview of Functionality</h3>
<p>The application provides a web-based chat interface where a user can have a conversation with an AI assistant. Key features include:</p>
<ul>
<li><strong>Real-time Interaction:</strong> Uses WebSockets for instant message delivery between the client and server.</li>
<li><strong>Session Management:</strong> Each user conversation is tracked in a unique session, both for the AI model’s memory and for observability tracing.</li>
<li><strong>AI Integration:</strong> Connects to the Google Gemini API to generate intelligent responses.</li>
<li><strong>LLM Observability:</strong> Integrates Langfuse to trace entire conversations, log individual AI generations (turns), and record performance metrics like token usage.</li>
<li><strong>User Feedback:</strong> Includes “thumbs up/down” buttons on AI responses, allowing users to provide feedback that is logged directly into Langfuse.</li>
<li><strong>Graceful Cleanup:</strong> Properly finalizes traces and releases resources when a user clears the chat or closes the browser tab.</li>
</ul>
</section>
<section id="initial-setup-and-configuration" class="level3">
<h3 class="anchored" data-anchor-id="initial-setup-and-configuration">Initial Setup and Configuration</h3>
<p>This section covers the initial boilerplate: importing necessary libraries, defining constants, and setting up the basic HTML structure and styling.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import necessary libraries and modules.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> traceback <span class="co"># For formatting exception tracebacks for logging.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Literal <span class="co"># For creating type hints for specific string values.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> uuid <span class="co"># For generating unique session IDs.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fasthtml.common <span class="im">import</span> <span class="op">*</span> <span class="co"># Core components from the FastHTML library.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fasthtml.components <span class="im">import</span> Zero_md <span class="co"># A specific component for rendering Markdown.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv <span class="co"># To load environment variables from a .env file.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google <span class="im">import</span> genai <span class="co"># The Google Generative AI client library.</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.genai.chats <span class="im">import</span> Chat <span class="co"># The specific Chat object from the Google library.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langfuse <span class="im">import</span> get_client <span class="co"># For getting the Langfuse client instance.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langfuse._client.span <span class="im">import</span> LangfuseSpan <span class="co"># The Langfuse Span object for tracing.</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os <span class="co"># For accessing environment variables.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langfuse.model <span class="im">import</span> ModelUsage <span class="co"># Langfuse model for tracking token usage.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Load environment variables from a .env file into the environment.</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Configuration Constants ---</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># The name of the environment variable that holds the Google API key.</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>GOOGLE_API_KEY_ENV <span class="op">=</span> <span class="st">"GOOGLE_API_KEY"</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># The specific Google Generative AI model to be used for the chat.</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>GOOGLE_MODEL_NAME <span class="op">=</span> <span class="st">"gemini-2.0-flash"</span> <span class="co"># Ensure this model name is correct for your Google AI setup</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Langfuse Constants ---</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># The name for the parent span that encompasses an entire chat conversation.</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>LANGFUSE_CONVERSATION_SPAN_NAME <span class="op">=</span> <span class="st">"chat_conversation"</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># The name for a generation span, representing a single turn from the language model.</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>LANGFUSE_GENERATION_NAME <span class="op">=</span> <span class="st">"llm_turn"</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># The name used in Langfuse for scores that come from user feedback.</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>LANGFUSE_SCORE_NAME <span class="op">=</span> <span class="st">"user_feedback_score"</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a type alias 'Role' which can only be the string "user" or "assistant".</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> Role <span class="op">=</span> Literal[<span class="st">"user"</span>, <span class="st">"assistant"</span>]</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the HTML headers for the application.</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># This includes CSS and JavaScript for styling and functionality.</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>hdrs <span class="op">=</span> (</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    picolink, <span class="co"># A minimal CSS framework.</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    Script(src<span class="op">=</span><span class="st">"https://cdn.tailwindcss.com"</span>), <span class="co"># Tailwind CSS for utility-first styling.</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    Link(rel<span class="op">=</span><span class="st">"stylesheet"</span>, href<span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/npm/daisyui@4.11.1/dist/full.min.css"</span>), <span class="co"># DaisyUI component library for Tailwind.</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    Script(<span class="bu">type</span><span class="op">=</span><span class="st">"module"</span>, src<span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/npm/zero-md@3?register"</span>), <span class="co"># Zero-md for rendering markdown content on the client side.</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This section of the code handles the initial setup and configuration for the chatbot application. It begins by importing essential libraries for web development (such as <code>fasthtml</code>), type hinting, unique session ID generation, environment variable management, AI integration with Google Gemini, and observability with Langfuse. The <code>load_dotenv()</code> function is called to securely load environment variables (like API keys) from a <code>.env</code> file, keeping sensitive information out of the source code. Several configuration constants are defined to centralize settings such as the Google model name, environment variable names, and Langfuse tracing identifiers, making the codebase easier to maintain and update. A <code>Role</code> type is specified using Python’s <code>Literal</code> type hint, restricting valid roles to “user” or “assistant” for improved code safety and clarity. The <code>hdrs</code> tuple collects all necessary CSS and JavaScript resources to be included in the HTML header, including the minimal <code>picolink</code> CSS, TailwindCSS for utility-first styling, daisyUI for ready-made UI components, and Zero-md for client-side Markdown rendering of chat messages.</p>
</section>
<section id="markdown-rendering-helper" class="level3">
<h3 class="anchored" data-anchor-id="markdown-rendering-helper">Markdown Rendering Helper</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> render_local_md(md: <span class="bu">str</span>) <span class="op">-&gt;</span> Zero_md:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Renders a markdown string using the Zero-md component.</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">    It injects custom CSS to override the default white background and dark text,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    allowing the markdown to inherit the styling of its container (e.g., the chat bubble).</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CSS to unset the default background and color, making it transparent.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    css <span class="op">=</span> <span class="st">'.markdown-body {background-color: unset !important; color: unset !important;}'</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># A template to hold the custom style.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    css_template <span class="op">=</span> Template(Style(css), data_append<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The Zero_md component containing the style and the markdown content.</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Zero_md(css_template, Script(md, <span class="bu">type</span><span class="op">=</span><span class="st">"text/markdown"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This function is a utility for rendering Markdown content within the chat interface. It uses the <code>Zero_md</code> component from FastHTML to convert Markdown strings into HTML. The function first defines custom CSS to override the default white background and dark text color of the Markdown, allowing it to inherit the styles of its parent container (like a chat bubble). This ensures that the rendered Markdown blends seamlessly with the chat UI. The function is drawn from <a href="https://isaac-flath.github.io/website/posts/boots/FasthtmlTutorial.html">Isaac Flath article</a>.</p>
<p>Note that there exist other ways to render Markdown in FastHTML, see <a href="#sec-appendix-rendering-markdown" class="quarto-xref">Section&nbsp;6</a>.</p>
</section>
<section id="the-sessionsmanager-class" class="level3">
<h3 class="anchored" data-anchor-id="the-sessionsmanager-class">The <code>SessionsManager</code> Class</h3>
<p>This class is the cornerstone of the application’s state management. It encapsulates all interactions with the external Google and Langfuse services, and it keeps track of individual user sessions. This design prevents global state and allows the application to handle multiple concurrent users cleanly.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SessionsManager:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Manages all session-related states, including Google GenAI chat sessions</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    and Langfuse tracing spans, mapping them by a unique session ID.</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initializes the SessionsManager, setting up Google and Langfuse clients."""</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Retrieve the Google API key from environment variables.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        google_api_key <span class="op">=</span> os.getenv(GOOGLE_API_KEY_ENV)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> google_api_key:</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Environment variable '</span><span class="sc">{</span>GOOGLE_API_KEY_ENV<span class="sc">}</span><span class="ss">' is not set."</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Configure and create the Google GenAI client.</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.google_client <span class="op">=</span> genai.Client(api_key<span class="op">=</span>google_api_key)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for and initialize the Langfuse client.</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        required_langfuse_envs <span class="op">=</span> [<span class="st">"LANGFUSE_PUBLIC_KEY"</span>, <span class="st">"LANGFUSE_SECRET_KEY"</span>, <span class="st">"LANGFUSE_HOST"</span>]</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        missing <span class="op">=</span> [env <span class="cf">for</span> env <span class="kw">in</span> required_langfuse_envs <span class="cf">if</span> <span class="kw">not</span> os.getenv(env)]</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> missing:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Missing required Langfuse environment variables: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(missing)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.langfuse_client <span class="op">=</span> get_client()</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verify that the Langfuse credentials are correct.</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.langfuse_client.auth_check():</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"Failed to initialize Langfuse client. Check your environment variables."</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dictionaries to store active sessions, keyed by session_id.</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._chats: <span class="bu">dict</span>[<span class="bu">str</span>, Chat] <span class="op">=</span> {} <span class="co"># Stores Google GenAI chat objects.</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._conversations_spans: <span class="bu">dict</span>[<span class="bu">str</span>, LangfuseSpan] <span class="op">=</span> {} <span class="co"># Stores Langfuse conversation spans.</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_google_chat_session(<span class="va">self</span>, session_id: <span class="bu">str</span>) <span class="op">-&gt;</span> Chat:</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieves the Google GenAI chat session for a given session ID.</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co">        If a session doesn't exist, it creates a new one.</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> session_id <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>._chats:</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a new chat session using the specified model.</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._chats[session_id] <span class="op">=</span> <span class="va">self</span>.google_client.chats.create(model<span class="op">=</span>GOOGLE_MODEL_NAME)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._chats[session_id]</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> clear_google_chat_session(<span class="va">self</span>, session_id: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Removes the Google GenAI chat session for a given session ID, effectively resetting it."""</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> session_id <span class="kw">in</span> <span class="va">self</span>._chats:</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>            <span class="kw">del</span> <span class="va">self</span>._chats[session_id]</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_conversation_span(<span class="va">self</span>, session_id: <span class="bu">str</span>) <span class="op">-&gt;</span> LangfuseSpan:</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieves or creates the parent Langfuse span for the entire conversation.</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co">        This span groups all related LLM turns (generations) into a single trace.</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> session_id <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>._conversations_spans:</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Start a new span (which also creates a new trace).</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._conversations_spans[session_id] <span class="op">=</span> <span class="va">self</span>.langfuse_client.start_span(name<span class="op">=</span>LANGFUSE_CONVERSATION_SPAN_NAME)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Associate the trace with the user's session ID for filtering in Langfuse.</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._conversations_spans[session_id].update_trace(user_id<span class="op">=</span>session_id)</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._conversations_spans[session_id]</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> end_conversation_span(<span class="va">self</span>, session_id: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="co">        Ends the current Langfuse conversation span and ensures all buffered</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="co">        data is sent to the Langfuse server.</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> session_id <span class="kw">in</span> <span class="va">self</span>._conversations_spans:</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._conversations_spans[session_id].end()</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>            <span class="kw">del</span> <span class="va">self</span>._conversations_spans[session_id]</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.langfuse_client.flush() <span class="co"># Manually flush to ensure data is sent.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>SessionsManager</code> class is responsible for managing all session-related state and external service interactions in the chatbot application. Its constructor (<code>__init__</code>) ensures that all required environment variables for both Google Gemini and Langfuse are present, raising clear errors if any are missing, which helps catch configuration issues early. It initializes the Google GenAI client and the Langfuse client, and sets up two dictionaries—<code>_chats</code> for storing active Google chat sessions and <code>_conversations_spans</code> for tracking Langfuse conversation spans—each keyed by a unique <code>session_id</code>. The <code>get_google_chat_session</code> method retrieves or creates a Google chat session for a given user, maintaining conversation context across messages. Similarly, <code>get_conversation_span</code> retrieves or creates a top-level Langfuse span for the conversation, which acts as a parent for all LLM generations and is tagged with the <code>session_id</code> for traceability. The <code>clear_google_chat_session</code> and <code>end_conversation_span</code> methods handle cleanup by removing session objects from memory and, in the case of Langfuse, marking the span as complete and flushing any buffered data to ensure all observability information is sent.</p>
</section>
<section id="application-initialization-ui-components-and-main-page" class="level3">
<h3 class="anchored" data-anchor-id="application-initialization-ui-components-and-main-page">Application Initialization, UI Components and Main Page</h3>
<p>This section defines the FastHTML components that make up the user interface and initializes the <code>FastHTML</code> application itself.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the FastHTML application with the defined headers and a default CSS class.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastHTML(hdrs<span class="op">=</span>hdrs, cls<span class="op">=</span><span class="st">"p-4 max-w-lg mx-auto"</span>, exts<span class="op">=</span><span class="st">"ws"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a single instance of the SessionsManager to be used by the entire application.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>sessions_manager <span class="op">=</span> SessionsManager()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ChatMessage(msg: <span class="bu">str</span>, role: Role, trace_id: <span class="bu">str</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>, observation_id: <span class="bu">str</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> Div:</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    A component function that renders a single chat message bubble.</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    rendered_msg <span class="op">=</span> render_local_md(msg) <span class="co"># Convert markdown text to a renderable component.</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine bubble color based on the role (user or assistant).</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    bubble_class <span class="op">=</span> <span class="st">"chat-bubble-primary"</span> <span class="cf">if</span> role <span class="op">==</span> <span class="st">"user"</span> <span class="cf">else</span> <span class="st">'chat-bubble-secondary'</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine bubble alignment based on the role.</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    chat_class <span class="op">=</span> <span class="st">"chat-end"</span> <span class="cf">if</span> role <span class="op">==</span> <span class="st">"user"</span> <span class="cf">else</span> <span class="st">'chat-start'</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    feedback_buttons_html <span class="op">=</span> <span class="st">""</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only show feedback buttons for assistant messages that have tracing info.</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> role <span class="op">==</span> <span class="st">"assistant"</span> <span class="kw">and</span> trace_id <span class="kw">and</span> observation_id:</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        feedback_container_id <span class="op">=</span> <span class="ss">f"feedback-</span><span class="sc">{</span>observation_id<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Values to be sent when the user clicks the "like" button.</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        vals_up <span class="op">=</span> {<span class="st">"observation_id"</span>: observation_id, <span class="st">"trace_id"</span>: trace_id, <span class="st">"score"</span>: <span class="dv">1</span>}</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Values to be sent when the user clicks the "dislike" button.</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        vals_down <span class="op">=</span> {<span class="st">"observation_id"</span>: observation_id, <span class="st">"trace_id"</span>: trace_id, <span class="st">"score"</span>: <span class="dv">0</span>}</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create the feedback buttons using htmx attributes for AJAX POST requests.</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        feedback_buttons_html <span class="op">=</span> Div(</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>            Button(</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">"👍"</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                hx_post<span class="op">=</span><span class="st">"/score_message"</span>, hx_vals<span class="op">=</span>vals_up, <span class="co"># POST to /score_message with 'up' values.</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                hx_target<span class="op">=</span><span class="ss">f"#</span><span class="sc">{</span>feedback_container_id<span class="sc">}</span><span class="ss">"</span>, hx_swap<span class="op">=</span><span class="st">"outerHTML"</span>, <span class="co"># Replace the buttons with the response.</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                cls<span class="op">=</span><span class="st">"btn btn-xs btn-ghost"</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            Button(</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">"👎"</span>,</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>                hx_post<span class="op">=</span><span class="st">"/score_message"</span>, hx_vals<span class="op">=</span>vals_down, <span class="co"># POST to /score_message with 'down' values.</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>                hx_target<span class="op">=</span><span class="ss">f"#</span><span class="sc">{</span>feedback_container_id<span class="sc">}</span><span class="ss">"</span>, hx_swap<span class="op">=</span><span class="st">"outerHTML"</span>, <span class="co"># Replace the buttons with the response.</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                cls<span class="op">=</span><span class="st">"btn btn-xs btn-ghost"</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span>feedback_container_id,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>            cls<span class="op">=</span><span class="st">"flex space-x-1 mt-1"</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct the final chat message div.</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Div(cls<span class="op">=</span><span class="ss">f"chat </span><span class="sc">{</span>chat_class<span class="sc">}</span><span class="ss">"</span>)(</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        Div(role, cls<span class="op">=</span><span class="st">"chat-header"</span>),</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        Div(rendered_msg, cls<span class="op">=</span><span class="ss">f"chat-bubble </span><span class="sc">{</span>bubble_class<span class="sc">}</span><span class="ss">"</span>),</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        feedback_buttons_html <span class="cf">if</span> feedback_buttons_html <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ChatInput() <span class="op">-&gt;</span> Input:</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co">    A component function that returns the chat input field.</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co">    The `hx_swap_oob='true'` attribute allows this component to be targeted</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="co">    for an "Out of Band" swap, which is used to clear the input after a message is sent.</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Input(</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">'msg'</span>, </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">'msg-input'</span>, </span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        placeholder<span class="op">=</span><span class="st">"Type a message"</span>,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        cls<span class="op">=</span><span class="st">"input input-bordered w-full"</span>, </span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        hx_swap_oob<span class="op">=</span><span class="st">'true'</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        autocomplete<span class="op">=</span><span class="st">"off"</span>,  <span class="co"># Disable browser's native autocomplete.</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="co"># The main application route, handling GET requests to the root URL.</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/"</span>)</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index():</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Defines the main chat page UI."""</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The main form element that handles WebSocket communication.</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    page <span class="op">=</span> Form(</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        ws_send<span class="op">=</span><span class="va">True</span>, <span class="co"># Automatically sends form data over the WebSocket on submit.</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        hx_ext<span class="op">=</span><span class="st">"ws"</span>, <span class="co"># Enables the htmx WebSocket extension.</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        ws_connect<span class="op">=</span><span class="st">"/wscon"</span>, <span class="co"># The WebSocket endpoint to connect to.</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    )(</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The container where chat messages will be appended.</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        Div(<span class="bu">id</span><span class="op">=</span><span class="st">"chatlist"</span>, cls<span class="op">=</span><span class="st">"chat-box h-[73vh] overflow-y-auto"</span>),</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The container for the input field and buttons.</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        Div(cls<span class="op">=</span><span class="st">"flex space-x-2 mt-2"</span>)(</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>            Group(</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>                ChatInput(), </span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>                Button(<span class="st">"Send"</span>, cls<span class="op">=</span><span class="st">"btn btn-primary"</span>, hx_vals<span class="op">=</span><span class="st">'{"action": "send"}'</span>),</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>                Button(<span class="st">"Clear Chat"</span>, cls<span class="op">=</span><span class="st">"btn btn-warning"</span>, hx_post<span class="op">=</span><span class="st">"/clear_chat"</span>, hx_target<span class="op">=</span><span class="st">"#chatlist"</span>, hx_swap<span class="op">=</span><span class="st">"innerHTML"</span>, hx_include<span class="op">=</span><span class="st">"[name='session_id']"</span>),</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># A hidden input to store the unique session ID for this client.</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        Hidden(name<span class="op">=</span><span class="st">"session_id"</span>, <span class="bu">id</span><span class="op">=</span><span class="st">"session-id"</span>, hx_swap_oob<span class="op">=</span><span class="st">"true"</span>, value<span class="op">=</span><span class="bu">str</span>(uuid.uuid4())),</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the page wrapped in a title.</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Titled(<span class="st">'Chatbot Demo'</span>, page)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>app = FastHTML(...)</code> line creates the application instance, injecting the previously defined CSS and JavaScript resources (<code>hdrs</code>), applying TailwindCSS classes for layout, and enabling the HTMX WebSocket extension for real-time communication. A single <code>SessionsManager</code> instance is created to handle all session and external service management.</p>
<p>The <code>ChatMessage</code> function generates the HTML for each chat bubble, styling it based on the sender’s role and rendering the message content as Markdown using the <code>render_local_md</code> helper. For assistant messages, if tracing information is available, it conditionally adds “thumbs up/down” feedback buttons, which use HTMX attributes to send POST requests to the server and update the UI in place.</p>
<p>The <code>ChatInput</code> function creates the chat input field, using the <code>hx_swap_oob='true'</code> attribute to ensure the input is cleared after each message, regardless of the main target of the server response. This design provides a responsive, interactive chat interface with integrated observability and user feedback mechanisms.</p>
<p>The main page route is defined in the <code>index</code> function, which returns the initial HTML structure for the chatbot interface. This structure includes a display area for chat messages (<code>chatlist</code>), an input field for user messages, “Send” and “Clear Chat” buttons, and a hidden input field containing a unique session ID to track the user’s conversation. The form is configured for real-time updates using WebSocket communication, leveraging HTMX and FastHTML extensions. Specifically, the <code>@app.get("/")</code> decorator registers the handler for the root URL, constructing the main page with a form that connects to the <code>/wscon</code> WebSocket endpoint (<code>ws_connect="/wscon"</code>) and submits data over the WebSocket (<code>ws_send=True</code>). The chat messages are displayed in a <code>div</code> with <code>id="chatlist"</code>, while the “Clear Chat” button triggers a standard HTTP POST request, ensuring the session ID is included via <code>hx_include="[name='session_id']"</code>. The hidden input for <code>session_id</code> is initialized with a placeholder value, enabling session tracking for each user.</p>
</section>
<section id="websocket" class="level3">
<h3 class="anchored" data-anchor-id="websocket">WebSocket</h3>
<p>The functions below handle WebSocket connections, disconnections, and message processing. They manage the lifecycle of user sessions, including session ID generation, message handling, and cleanup on disconnection.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> on_connect(ws, send):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Callback function executed when a new WebSocket connection is established."""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate a new unique ID for this session.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    session_id <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4())</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store the session ID in the WebSocket's scope for later access.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    ws.scope[<span class="st">'session_id'</span>] <span class="op">=</span> session_id</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Send a new hidden input field to the client via an OOB swap.</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This updates the `session-id` input on the client with the server-generated ID.</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> send(Hidden(name<span class="op">=</span><span class="st">"session_id"</span>, <span class="bu">id</span><span class="op">=</span><span class="st">"session-id"</span>, value<span class="op">=</span>session_id, hx_swap_oob<span class="op">=</span><span class="st">"true"</span>))</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"SERVER: WebSocket connected. Session ID: </span><span class="sc">{</span>session_id<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> on_disconnect(ws):</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Callback function executed when a WebSocket connection is closed.</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">    This is used for cleaning up server-side resources associated with the session.</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Retrieve the session ID from the connection's scope.</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    session_id <span class="op">=</span> ws.scope.get(<span class="st">'session_id'</span>, <span class="va">None</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> session_id:</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ERROR: WebSocket disconnect called without a session ID. Cannot clean up."</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"SERVER: WebSocket disconnected for Session ID: </span><span class="sc">{</span>session_id<span class="sc">}</span><span class="ss">. Cleaning up session."</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the session objects.</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        current_chat_session <span class="op">=</span> sessions_manager.get_google_chat_session(session_id<span class="op">=</span>session_id)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        conv_span <span class="op">=</span> sessions_manager.get_conversation_span(session_id<span class="op">=</span>session_id)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the full chat history from the Google chat object.</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: message.role, <span class="st">"content"</span>: <span class="bu">getattr</span>(message.parts[<span class="dv">0</span>], <span class="st">"text"</span>, <span class="st">""</span>)}</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> message <span class="kw">in</span> current_chat_session.get_history()</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(message, <span class="st">"role"</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(message, <span class="st">"parts"</span>) <span class="kw">and</span> message.parts</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update the Langfuse span with the full conversation history before ending it.</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> messages <span class="kw">and</span> conv_span:</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            conv_span.update(</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>                <span class="bu">input</span><span class="op">=</span>messages[:<span class="op">-</span><span class="dv">1</span>],  <span class="co"># All messages except the last are considered input.</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>                output<span class="op">=</span>messages[<span class="op">-</span><span class="dv">1</span>],  <span class="co"># The final message is the output of the whole conversation.</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clean up the session data from the manager.</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        sessions_manager.clear_google_chat_session(session_id<span class="op">=</span>session_id)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        sessions_manager.end_conversation_span(session_id<span class="op">=</span>session_id)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"SERVER: Cleanup complete for session: </span><span class="sc">{</span>session_id<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log any errors that occur during the cleanup process.</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"ERROR during WebSocket disconnect cleanup for Session ID: </span><span class="sc">{</span>session_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>traceback<span class="sc">.</span>format_exc()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="at">@app.ws</span>(<span class="st">"/wscon"</span>, conn<span class="op">=</span>on_connect, disconn<span class="op">=</span>on_disconnect)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> ws_chat_handler(msg:<span class="bu">str</span>, ws, send):</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="co">    The main WebSocket message handler. This is called every time a message is</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="co">    received from a client over the WebSocket.</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the session ID associated with this WebSocket connection.</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    session_id <span class="op">=</span> ws.scope.get(<span class="st">'session_id'</span>, <span class="va">None</span>)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> session_id:</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ERROR: WebSocket handler called without a session ID. Cannot process message."</span>)</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ignore empty messages from the client.</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> msg.strip():</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> send(ChatInput()) <span class="co"># Resend a clean input field.</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the conversation span and chat session are ready.</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    conv_span <span class="op">=</span> sessions_manager.get_conversation_span(session_id<span class="op">=</span>session_id)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    current_chat_session <span class="op">=</span> sessions_manager.get_google_chat_session(session_id<span class="op">=</span>session_id)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the trace ID for this conversation to pass to the UI for feedback.</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    trace_id <span class="op">=</span> conv_span.trace_id</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Optimistic UI Update ---</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Immediately send the user's message back to them so it appears in the chat list.</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> send(Div(ChatMessage(msg<span class="op">=</span>msg, role<span class="op">=</span><span class="st">"user"</span>), hx_swap_oob<span class="op">=</span><span class="st">'beforeend'</span>, <span class="bu">id</span><span class="op">=</span><span class="st">"chatlist"</span>))</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Send a new, empty input field to clear the user's input.</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> send(ChatInput())</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Start a Langfuse generation span to trace this specific LLM call.</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> conv_span.start_as_current_generation(name<span class="op">=</span>LANGFUSE_GENERATION_NAME, <span class="bu">input</span><span class="op">=</span>msg, model<span class="op">=</span>GOOGLE_MODEL_NAME) <span class="im">as</span> generation:</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Send the user's message to the Google GenAI API.</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> current_chat_session.send_message(msg)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>            r <span class="op">=</span> response.text.rstrip()  <span class="co"># Get the response text and clean it.</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a ModelUsage object with token counts from the response metadata.</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>            usage <span class="op">=</span> ModelUsage(</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>                <span class="bu">input</span><span class="op">=</span>response.usage_metadata.prompt_token_count,</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>                output<span class="op">=</span>response.usage_metadata.candidates_token_count,</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>                total<span class="op">=</span>response.usage_metadata.total_token_count,</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update the Langfuse generation with the output and token usage.</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>            generation.update(output<span class="op">=</span>r, usage_details<span class="op">=</span>usage)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the unique ID of this generation for the feedback mechanism.</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>            observation_id <span class="op">=</span> generation.<span class="bu">id</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Send the assistant's response to the client's chat list.</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> send(Div(ChatMessage(msg<span class="op">=</span>r, role<span class="op">=</span><span class="st">"assistant"</span>, trace_id<span class="op">=</span>trace_id, observation_id<span class="op">=</span>observation_id), hx_swap_oob<span class="op">=</span><span class="st">'beforeend'</span>, <span class="bu">id</span><span class="op">=</span><span class="st">"chatlist"</span>))</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log the full error on the server for debugging.</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"ERROR in WebSocket handler during AI call: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>traceback<span class="sc">.</span>format_exc()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log the error as an "event" within the Langfuse conversation trace for observability.</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> conv_span:</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>            conv_span.create_event(</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span><span class="st">"llm_turn_error"</span>, </span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>                level<span class="op">=</span><span class="st">"ERROR"</span>, </span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>                status_message<span class="op">=</span><span class="bu">str</span>(e), </span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>                metadata<span class="op">=</span>{<span class="st">"traceback"</span>: traceback.format_exc()}</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Send a user-friendly error message to the chat UI.</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>        error_ui_msg <span class="op">=</span> <span class="st">"Sorry, I encountered an issue processing your message. Please try again."</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> send(Div(ChatMessage(msg<span class="op">=</span>error_ui_msg, role<span class="op">=</span><span class="st">"assistant"</span>), hx_swap_oob<span class="op">=</span><span class="st">'beforeend'</span>, <span class="bu">id</span><span class="op">=</span><span class="st">"chatlist"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>on_connect</code> asynchronous function is triggered when a client establishes a WebSocket connection. It generates a unique <code>session_id</code> using <code>uuid.uuid4()</code> and stores this identifier in the WebSocket’s <code>scope</code> dictionary, which holds connection-specific data. The function then sends a hidden input component containing the new session ID back to the client. Thanks to the <code>hx_swap_oob="true"</code> attribute and a matching <code>id</code>, HTMX seamlessly replaces the placeholder <code>session-id</code> on the client side with this server-generated value.</p>
<p>The <code>on_disconnect</code> function is called when the client disconnects, such as when the browser tab is closed. This function is essential for resource cleanup. It retrieves the <code>session_id</code> from the WebSocket’s scope and uses the <code>sessions_manager</code> to access the final chat history. Before ending the session, it updates the top-level Langfuse span with the complete conversation, specifying the full input and output. This ensures that Langfuse maintains a comprehensive record of the chat. The function then calls the manager’s methods to end the span and clear the session data from memory. Wrapping this logic in a <code>try/except</code> block ensures that any errors during cleanup do not disrupt the server.</p>
<p>The <code>@app.ws(...)</code> decorator registers the main WebSocket handler for the <code>/wscon</code> endpoint and associates the <code>on_connect</code> and <code>on_disconnect</code> functions for connection lifecycle management. The handler receives the user’s message (<code>msg</code>), the WebSocket connection object (<code>ws</code>), and a <code>send</code> function for returning data to the client. It begins by retrieving the <code>session_id</code>, ignoring empty messages, and obtaining the active chat session and Langfuse span from the <code>sessions_manager</code>.</p>
<p>For immediate user feedback, the handler sends two components back to the client: the user’s message, rendered as a <code>ChatMessage</code> and appended to the chat list using <code>hx_swap_oob='beforeend'</code> and <code>id="chatlist"</code>, and a new <code>ChatInput()</code> component, which clears the input field due to its <code>hx_swap_oob='true'</code> attribute.</p>
<p>The core logic for handling the AI response is wrapped in a <code>try/except</code> block. Within this block, a Langfuse generation span is started using a context manager, which logs the input message and model name, and automatically tracks timing. The user’s message is sent to the Google Gemini API, and the response text and token usage metadata are extracted. The generation span is then updated with the AI’s output and usage details, and the unique <code>observation_id</code> for this generation is retrieved from Langfuse. This ID, along with the <code>trace_id</code>, is used to enable the feedback buttons in the chat UI.</p>
<p>Finally, the AI’s response is sent to the client as a <code>ChatMessage</code>, including the necessary identifiers for feedback. If an error occurs during the API call, the exception is caught, logged to the server console, and an error event is created in Langfuse for observability. The user also receives a friendly error message in the chat interface.</p>
</section>
<section id="supporting-http-endpoints" class="level3">
<h3 class="anchored" data-anchor-id="supporting-http-endpoints">Supporting HTTP Endpoints</h3>
<p>These are standard HTTP endpoints that support auxiliary actions like clearing the chat and scoring messages.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">"/clear_chat"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clear_chat(session_id: <span class="bu">str</span>):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    HTTP endpoint to handle the 'Clear Chat' button press.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    It resets the chat session on the server.</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Retrieve the current session objects.</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    current_chat_session <span class="op">=</span> sessions_manager.get_google_chat_session(session_id<span class="op">=</span>session_id)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    conv_span <span class="op">=</span> sessions_manager.get_conversation_span(session_id<span class="op">=</span>session_id)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract chat history before clearing, to update the Langfuse trace.</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"role"</span>: message.role, <span class="st">"content"</span>: <span class="bu">getattr</span>(message.parts[<span class="dv">0</span>], <span class="st">"text"</span>, <span class="st">""</span>)}</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> message <span class="kw">in</span> current_chat_session.get_history()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(message, <span class="st">"role"</span>) <span class="kw">and</span> <span class="bu">hasattr</span>(message, <span class="st">"parts"</span>) <span class="kw">and</span> message.parts</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the Langfuse span with the full conversation history.</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> messages <span class="kw">and</span> conv_span:</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        conv_span.update(</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">input</span><span class="op">=</span>messages[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            output<span class="op">=</span>messages[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clear the server-side session data and end the Langfuse span.</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    sessions_manager.clear_google_chat_session(session_id<span class="op">=</span>session_id)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    sessions_manager.end_conversation_span(session_id<span class="op">=</span>session_id)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return an empty chat list (to replace the old one) and a fresh input field.</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Div(<span class="bu">id</span><span class="op">=</span><span class="st">"chatlist"</span>, cls<span class="op">=</span><span class="st">"chat-box h-[73vh] overflow-y-auto"</span>), ChatInput()</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">"/score_message"</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_message(trace_id: <span class="bu">str</span>, observation_id: <span class="bu">str</span>, score: <span class="bu">int</span>):</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co">    HTTP endpoint to handle user feedback (👍/👎).</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co">    It logs a score in Langfuse for the specific LLM generation.</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the Langfuse client to create a score.</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        sessions_manager.langfuse_client.create_score(</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span>LANGFUSE_SCORE_NAME,</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>            trace_id<span class="op">=</span>trace_id, <span class="co"># Link the score to the correct conversation trace.</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>            observation_id<span class="op">=</span>observation_id, <span class="co"># Link the score to the specific message.</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>            value<span class="op">=</span>score, <span class="co"># The score value (1 for like, 0 for dislike).</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>            data_type<span class="op">=</span><span class="st">"BOOLEAN"</span>, <span class="co"># The type of the score value.</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure the score is sent immediately.</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        sessions_manager.langfuse_client.flush()</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return a "Thanks!" message to replace the feedback buttons in the UI.</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> P(<span class="st">"Thanks!"</span>, cls<span class="op">=</span><span class="st">"text-xs text-success mt-1 ml-2"</span>)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log any error that occurs while trying to record the score.</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error scoring message: </span><span class="sc">{</span>observation_id<span class="sc">}</span><span class="ss">, score: </span><span class="sc">{</span>score<span class="sc">}</span><span class="ss">, error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>traceback<span class="sc">.</span>format_exc()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Also, try to log this scoring failure as an event in Langfuse for better observability.</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            sessions_manager.langfuse_client.event(</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>                trace_id<span class="op">=</span>trace_id,</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                parent_observation_id<span class="op">=</span>observation_id,</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span><span class="st">"scoring_error"</span>,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>                level<span class="op">=</span><span class="st">"ERROR"</span>,</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                <span class="bu">input</span><span class="op">=</span>{<span class="st">"observation_id"</span>: observation_id, <span class="st">"score_attempted"</span>: score},</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>                output<span class="op">=</span>{<span class="st">"error_message"</span>: <span class="bu">str</span>(e)},</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>                metadata<span class="op">=</span>{<span class="st">"traceback"</span>: traceback.format_exc()}</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>            sessions_manager.langfuse_client.flush()</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> langfuse_event_err:</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"CRITICAL: Failed to log scoring error to Langfuse: </span><span class="sc">{</span>langfuse_event_err<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return an error message to the user.</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> P(<span class="st">"Error."</span>, cls<span class="op">=</span><span class="st">"text-xs text-error mt-1 ml-2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The two HTTP endpoints, <code>@app.post("/clear_chat")</code> and <code>@app.post("/score_message")</code>, provide essential support for the chatbot’s user experience and observability features.</p>
<p>The <code>/clear_chat</code> endpoint is triggered when the user clicks the “Clear Chat” button. It receives the <code>session_id</code> from the form data and performs cleanup similar to the WebSocket disconnect logic: it finalizes the current Langfuse trace by updating it with the full conversation history, clears the server-side chat session, and ends the Langfuse span. The endpoint then returns an empty chat list (a <code>Div</code> with <code>id="chatlist"</code>) to replace the current chat content, and a new <code>ChatInput()</code> component to clear the input field. This ensures the UI is reset for a fresh conversation.</p>
<p>The <code>/score_message</code> endpoint handles user feedback submitted via the “thumbs up” or “thumbs down” buttons on assistant messages. FastHTML automatically parses the <code>hx-vals</code> JSON data from the button into function arguments (<code>trace_id</code>, <code>observation_id</code>, and <code>score</code>). The endpoint calls <code>sessions_manager.langfuse_client.create_score()</code>, linking the feedback to the specific AI generation and trace in Langfuse. If the score is recorded successfully, it returns a simple “Thanks!” message, which replaces the feedback buttons in the UI to prevent repeated submissions. Robust error handling is included: if the score submission fails, the error is logged, and an error event is also attempted in Langfuse for observability. The user sees an error message in the UI if something goes wrong.</p>
<p>Together, these endpoints ensure that chat state can be reset cleanly and that user feedback is reliably captured and linked to the correct AI responses for later analysis in Langfuse.</p>
</section>
</section>
</section>
<section id="run-the-chatbot-application" class="level1">
<h1>Run the Chatbot Application</h1>
<p>After all this step by step analysis of the code, let’s have fun running the chatbot application!</p>
<p>To run the chatbot application, please refer to the instructions in the <a href="https://nbrosse.github.io/llm-observability/README.md">README</a>.</p>
<p>Once the Langfuse docker container is running, you can start the FastHTML application using the following command.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> uv run app/chat_fasthtml.py</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Link:</span> http://localhost:5001</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Will watch for changes in these directories: <span class="pp">[</span><span class="st">'/home/nicolas/PycharmProjects/llm-observability'</span><span class="pp">]</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Uvicorn running on http://0.0.0.0:5001 <span class="er">(</span><span class="ex">Press</span> CTRL+C to quit<span class="kw">)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Started reloader process <span class="pp">[</span><span class="ss">201742</span><span class="pp">]</span> using WatchFiles</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Started server process <span class="pp">[</span><span class="ss">201830</span><span class="pp">]</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Waiting for application startup.</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     Application startup complete.</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     127.0.0.1:40808 <span class="at">-</span> <span class="st">"GET / HTTP/1.1"</span> 200 OK</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     127.0.0.1:40816 <span class="at">-</span> <span class="st">"WebSocket /wscon"</span> <span class="pp">[</span><span class="ss">accepted</span><span class="pp">]</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     connection open</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     127.0.0.1:40808 <span class="at">-</span> <span class="st">"GET /favicon.ico HTTP/1.1"</span> 404 Not Found</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="ex">SERVER:</span> WebSocket connected. Session ID: 24a0a9ff-bf1d-467f-a7ab-c3f67ddb7d0d.</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     127.0.0.1:51564 <span class="at">-</span> <span class="st">"POST /score_message HTTP/1.1"</span> 200 OK</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="ex">INFO:</span>     127.0.0.1:51998 <span class="at">-</span> <span class="st">"POST /score_message HTTP/1.1"</span> 200 OK</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You observe all the logs in the terminal, including the WebSocket connection, incoming messages, and any errors that may occur during processing. The application is accessible at <code>http://localhost:5001</code> and you can interact with it through a web browser.</p>
<div id="fig-chatbot-demo" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Chatbot Demo Screenshot">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-chatbot-demo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/chatbot_demo.png" class="img-fluid figure-img" alt="Chatbot Demo Screenshot">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-chatbot-demo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Screenshot of the FastHTML Chatbot with Langfuse integration
</figcaption>
</figure>
</div>
<p>We can access the traces on langfuse platform at <code>http://localhost:3000</code> (or the port you configured in the <code>docker-compose.yml</code> file). The traces will show the conversation history, including user messages, AI responses, and any feedback provided by users. This allows for detailed analysis of the chatbot’s performance and user interactions.</p>
<div id="fig-langfuse-trace" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Langfuse Trace Screenshot">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-langfuse-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/langfuse_trace.png" class="img-fluid figure-img" alt="Langfuse Trace Screenshot">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-langfuse-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Screenshot of Langfuse trace for the chatbot application
</figcaption>
</figure>
</div>
</section>
<section id="run-the-chatbot-application-1" class="level1">
<h1>Run the Chatbot Application</h1>
<p>After analyzing the code, it’s time to run the chatbot application and see it in action.</p>
<p><strong>Prerequisites</strong></p>
<p>Before starting the application, ensure you have followed the setup instructions in the <a href="https://nbrosse.github.io/llm-observability/README.md">project’s README</a>. Make sure the Langfuse Docker container is up and running.</p>
<p>Once the prerequisites are met, start the FastHTML application from your terminal with the following command:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> uv run app/chat_fasthtml.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should see output similar to the following, indicating the server has started successfully on port 5001 and is ready for connections:</p>
<pre class="log"><code>Link: http://localhost:5001
INFO:     Will watch for changes in these directories: ['/home/nicolas/PycharmProjects/llm-observability']
INFO:     Uvicorn running on http://0.0.0.0:5001 (Press CTRL+C to quit)
INFO:     Started reloader process [201742] using WatchFiles
INFO:     Started server process [201830]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     127.0.0.1:40808 - "GET / HTTP/1.1" 200 OK
INFO:     127.0.0.1:40816 - "WebSocket /wscon" [accepted]
INFO:     connection open
SERVER: WebSocket connected. Session ID: 24a0a9ff-bf1d-467f-a7ab-c3f67ddb7d0d.</code></pre>
<p>The terminal displays real-time logs for server activity, including WebSocket connections, incoming messages, and any errors.</p>
<p>You can interact with the chatbot by navigating to <code>http://localhost:5001</code> in your web browser.</p>
<div id="fig-chatbot-demo" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A web browser showing the chatbot interface with a conversation history, a message input box, and thumb up/down feedback buttons for each AI response.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-chatbot-demo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/chatbot_demo.png" class="img-fluid figure-img" alt="A web browser showing the chatbot interface with a conversation history, a message input box, and thumb up/down feedback buttons for each AI response.">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-chatbot-demo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: A web browser showing the chatbot interface with a conversation history, a message input box, and thumb up/down feedback buttons for each AI response.
</figcaption>
</figure>
</div>
<p>To view the observability data, open the Langfuse UI, which is typically available at <code>http://localhost:3000</code> (or the port you configured in the <code>docker-compose.yml</code> file).</p>
<p>In the Langfuse dashboard, you can explore the traces generated by the application. These traces provide a detailed breakdown of each conversation, including user messages, AI responses, and any feedback provided by users. This is very useful for analyzing the chatbot’s performance and debugging interactions.</p>
<div id="fig-langfuse-trace" class="quarto-float quarto-figure quarto-figure-center anchored" alt="The Langfuse dashboard displaying a trace for a chatbot conversation. The trace shows a timeline with nested spans for generation, user input, and scores.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-langfuse-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/langfuse_trace.png" class="img-fluid figure-img" alt="The Langfuse dashboard displaying a trace for a chatbot conversation. The trace shows a timeline with nested spans for generation, user input, and scores.">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-langfuse-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The Langfuse dashboard displaying a trace for a chatbot conversation. The trace shows a timeline with nested spans for generation, user input, and scores.
</figcaption>
</figure>
</div>
<p>You can also test by opening multiple browser tabs or windows to simulate different users interacting with the chatbot simultaneously. Each session will generate its own trace in Langfuse, allowing you to see how the application handles concurrent conversations.</p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>This FastHTML chatbot application demonstrates how to integrate Google GenAI with Langfuse for observability. It provides a responsive user interface, real-time interactions, and detailed tracing of AI-generated responses. The use of HTMX and WebSockets enhances the user experience by enabling immediate feedback and updates without full page reloads.</p>
</section>
<section id="sec-appendix-rendering-markdown" class="level1">
<h1>Appendix: Rendering Markdown in FastHTML</h1>
<p>This Appendix compares three approaches for rendering Markdown content within a FastHTML application, each with distinct mechanisms, trade-offs, and use cases.</p>
<ol type="1">
<li><strong>Custom JavaScript:</strong> Using a library like <code>marked.js</code> with a custom script.</li>
<li><strong>FastHTML Built-ins:</strong> Using the pre-packaged <code>MarkdownJS</code> and <code>HighlightJS</code> components.</li>
<li><strong>Web Component:</strong> Using a dedicated web component like <code>&lt;zero-md&gt;</code>.</li>
</ol>
<section id="approach-1-custom-javascript-with-marked.js" class="level2">
<h2 class="anchored" data-anchor-id="approach-1-custom-javascript-with-marked.js">Approach 1: Custom JavaScript with <code>marked.js</code></h2>
<p>This method involves manually including the <code>marked.js</code> library and writing a small script to process elements on the page.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Include the script in the &lt;head&gt; of your application</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>markdown_js <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="st">import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">proc_htmx('.markdown', e =&gt; e.innerHTML = marked.parse(e.textContent));</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastHTML(hdrs<span class="op">=</span>(..., Script(markdown_js, <span class="bu">type</span><span class="op">=</span><span class="st">'module'</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Mechanism:</strong> A JavaScript snippet imports <code>marked.js</code> from a CDN. It then uses the FastHTML helper <code>proc_htmx('.markdown', ...)</code> to find elements with the <code>markdown</code> class whenever content is loaded or swapped by HTMX. For each element found, the script takes its plain text content, parses it as Markdown, and replaces the element’s <code>innerHTML</code> with the resulting HTML.</p>
<p><strong>Usage:</strong> Place your raw Markdown string inside any container element and assign it the <code>markdown</code> class.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Rendering a Markdown-formatted chat message</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>Div(<span class="st">"**User:** How do I render Markdown in FastHTML?</span><span class="ch">\n\n</span><span class="st">**Assistant:** Use the `Div` component with the `markdown` class to display formatted content."</span>, cls<span class="op">=</span><span class="st">"markdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Styling</strong> is handled externally. You must provide your own CSS rules that target the HTML elements generated by <code>marked.js</code> (e.g., <code>h1</code>, <code>p</code>, <code>ul</code>) within the <code>.markdown</code> container.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Example external CSS */</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">.markdown</span> p {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">margin-bottom</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">.markdown</span> h1 {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">font-size</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">em</span><span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Key Characteristics</strong></p>
<ul>
<li>Global Processing: Relies on a global script that processes elements based on a CSS class.</li>
<li>Simple Logic: The core mechanism is straightforward—find an element, parse its text, and replace its content.</li>
<li>Separation of Concerns: Rendering logic (JS) is separate from styling (CSS).</li>
<li>Manual Setup: Requires you to write and maintain the script and library import.</li>
</ul>
</section>
<section id="approach-2-fasthtml-built-in-components" class="level2">
<h2 class="anchored" data-anchor-id="approach-2-fasthtml-built-in-components">Approach 2: FastHTML Built-in Components</h2>
<p>FastHTML provides convenient components, <code>MarkdownJS</code> and <code>HighlightJS</code>, that bundle the necessary client-side libraries and initialization scripts.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fasthtml.common <span class="im">import</span> <span class="op">*</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Include the components in the &lt;head&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>hdrs <span class="op">=</span> (MarkdownJS(), HighlightJS(langs<span class="op">=</span>[<span class="st">'python'</span>, <span class="st">'javascript'</span>, <span class="st">'html'</span>, <span class="st">'css'</span>]), )</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>app, rt <span class="op">=</span> fast_app(hdrs<span class="op">=</span>hdrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Mechanism</strong></p>
<ul>
<li><code>MarkdownJS()</code>: Injects a script that automatically finds elements with a specific class (typically <code>marked</code>) and renders their text content as Markdown. This is a “batteries-included” version of the custom <code>marked.js</code> approach.</li>
<li><code>HighlightJS()</code>: Injects the Highlight.js library and a script to apply syntax highlighting to code blocks (e.g., <code>&lt;pre&gt;&lt;code&gt;...&lt;/code&gt;&lt;/pre&gt;</code>). It works seamlessly with <code>MarkdownJS</code>, which generates the required HTML structure for fenced code blocks.</li>
</ul>
<p><strong>Usage:</strong> Place your raw Markdown string in a container element and assign it the <code>marked</code> class.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="at">@rt</span>(<span class="st">'/'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get(req):</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="st">    ## Example</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="st">    Here is some _markdown_ with a **code block**:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="st">    ```python</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="st">    def hello():</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="st">        print("Hello, world!")</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="st">    ```</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Titled(<span class="st">"Markdown Example"</span>, Div(content, cls<span class="op">=</span><span class="st">"marked"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Styling</strong></p>
<ul>
<li>Markdown: General elements (paragraphs, lists, headings) are styled by your main CSS, such as PicoCSS or custom stylesheets.</li>
<li>Syntax Highlighting: <code>HighlightJS</code> includes default CSS themes for code blocks.</li>
</ul>
<p><strong>Key Characteristics</strong></p>
<ul>
<li>Convenience: Uses pre-packaged components, reducing boilerplate for common tasks.</li>
<li>Integrated Solution: <code>MarkdownJS</code> and <code>HighlightJS</code> are designed to work together out of the box.</li>
<li>Client-Side Rendering: Both parsing and highlighting occur in the user’s browser.</li>
<li>FastHTML Native: A well-supported and idiomatic way to handle Markdown in the FastHTML ecosystem.</li>
</ul>
</section>
<section id="approach-3-using-the-zero-md-web-component" class="level2">
<h2 class="anchored" data-anchor-id="approach-3-using-the-zero-md-web-component">Approach 3: Using the <code>zero-md</code> Web Component</h2>
<p>This modern approach uses the <code>&lt;zero-md&gt;</code> web component, which encapsulates both rendering and styling.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Register the web component in the &lt;head&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>hdrs <span class="op">=</span> (</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    Script(<span class="bu">type</span><span class="op">=</span><span class="st">"module"</span>, src<span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/npm/zero-md@3?register"</span>),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Mechanism:</strong> <code>zero-md</code> is a self-contained custom HTML element (<code>&lt;zero-md&gt;</code>). It manages its own rendering lifecycle and styling, often using a Shadow DOM to prevent style conflicts. The Markdown source is passed to it inside a <code>&lt;script type="text/markdown"&gt;</code> tag.</p>
<p><strong>Usage:</strong> A helper function can abstract the component’s structure, making it easy to use.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to generate the &lt;zero-md&gt; component</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> render_local_md(md_content_string):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This CSS overrides zero-md defaults to inherit color from the parent</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    css <span class="op">=</span> <span class="st">'.markdown-body { background-color: unset !important; color: unset !important; }'</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># zero-md is styled via an internal &lt;template&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    css_template <span class="op">=</span> Template(Style(css), data_append<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Zero_md(</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        css_template,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        Script(md_content_string, <span class="bu">type</span><span class="op">=</span><span class="st">"text/markdown"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Rendering a Markdown-formatted chat message using zero-md</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>sample_message <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="st">**User:** How do I render Markdown in Fa    stHTML?</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="st">**Assistant:** Use the `render_local_md` helper function to display formatted Markdown content in your chat UI.</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>render_local_md(sample_message)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Styling:</strong> <code>zero-md</code> comes with its own default styles. You can customize them by passing a <code>&lt;template&gt;</code> containing <code>&lt;style&gt;</code> tags, as shown in the helper function. These styles are scoped to the component, preventing them from affecting the rest of your page.</p>
<p><strong>Key Characteristics</strong></p>
<ul>
<li>Encapsulation: Functionality and styling are self-contained, reducing the risk of CSS conflicts.</li>
<li>Declarative: You use a custom HTML tag (<code>&lt;zero-md&gt;</code>) to embed Markdown.</li>
<li>Rich Features: Often includes built-in syntax highlighting and theming.</li>
</ul>
</section>
<section id="comparison-of-approaches" class="level2">
<h2 class="anchored" data-anchor-id="comparison-of-approaches">Comparison of Approaches</h2>
<section id="summary-table" class="level3">
<h3 class="anchored" data-anchor-id="summary-table">Summary Table</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Custom <code>marked.js</code></th>
<th style="text-align: left;">FastHTML Built-ins</th>
<th style="text-align: left;"><code>zero-md</code> Web Component</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Type</strong></td>
<td style="text-align: left;">Custom JS snippet</td>
<td style="text-align: left;">FastHTML components</td>
<td style="text-align: left;">Web Component (<code>&lt;zero-md&gt;</code>)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Invocation</strong></td>
<td style="text-align: left;">Global JS on <code>.markdown</code> class</td>
<td style="text-align: left;">Auto-processes <code>.marked</code> class</td>
<td style="text-align: left;">Explicit use of <code>&lt;zero-md&gt;</code> tag</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>MD Source</strong></td>
<td style="text-align: left;">Element’s <code>textContent</code></td>
<td style="text-align: left;">Element’s <code>textContent</code></td>
<td style="text-align: left;"><code>&lt;script type="text/markdown"&gt;</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Styling (MD)</strong></td>
<td style="text-align: left;">External CSS</td>
<td style="text-align: left;">External CSS</td>
<td style="text-align: left;">Internal defaults, customizable via <code>&lt;template&gt;</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Styling (Code)</strong></td>
<td style="text-align: left;">Requires separate solution</td>
<td style="text-align: left;">Via <code>HighlightJS</code> themes</td>
<td style="text-align: left;">Built-in or via <code>&lt;template&gt;</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Encapsulation</strong></td>
<td style="text-align: left;">Low (global scope)</td>
<td style="text-align: left;">Medium (managed by components)</td>
<td style="text-align: left;">High (Shadow DOM)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Dependencies</strong></td>
<td style="text-align: left;">Manual include of <code>marked.js</code></td>
<td style="text-align: left;">Bundled by FastHTML</td>
<td style="text-align: left;">External include of <code>zero-md</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Ease of Use</strong></td>
<td style="text-align: left;">Simple but manual</td>
<td style="text-align: left;">Very simple and integrated</td>
<td style="text-align: left;">Simple with a Python helper</td>
</tr>
</tbody>
</table>
</section>
<section id="key-differences-and-recommendations" class="level3">
<h3 class="anchored" data-anchor-id="key-differences-and-recommendations">Key Differences and Recommendations</h3>
<p>The best approach depends on your project’s needs for simplicity, control, and integration.</p>
<ul>
<li><p><strong>Simplicity vs.&nbsp;Encapsulation:</strong> The <strong>FastHTML Built-ins</strong> offer the simplest, most integrated experience. The <strong><code>zero-md</code></strong> approach provides superior encapsulation, making it ideal for complex UIs where style conflicts are a concern (e.g., when using utility-first CSS frameworks like Tailwind). The custom <strong><code>marked.js</code></strong> approach is a good middle-ground if you want control without external dependencies beyond the library itself.</p></li>
<li><p><strong>Styling and Integration:</strong> With the <code>marked.js</code> and <code>MarkdownJS</code> approaches, the rendered HTML is part of the main document and is styled by global CSS. This makes global theming easy but can lead to style collisions. With <code>zero-md</code>, styling is scoped, which prevents conflicts but requires learning its specific customization method (via <code>&lt;template&gt;</code>). The example <code>css</code> for <code>zero-md</code> shows how to “break out” of its default theme to better blend with the surrounding page.</p></li>
</ul>
<section id="when-to-choose-each-approach" class="level4">
<h4 class="anchored" data-anchor-id="when-to-choose-each-approach">When to Choose Each Approach</h4>
<ul>
<li><p><strong>Use the Custom <code>marked.js</code> Approach</strong> for simple scenarios where you want full control over the script and prefer to manage styling globally without adding extra FastHTML components.</p></li>
<li><p><strong>Use the FastHTML Built-ins (<code>MarkdownJS</code> &amp; <code>HighlightJS</code>)</strong> as the default, recommended choice for most FastHTML projects. It’s the most convenient, “batteries-included” solution for rendering Markdown with syntax highlighting.</p></li>
<li><p><strong>Use the <code>zero-md</code> Web Component</strong> when style encapsulation is critical, especially when integrating into a complex UI with frameworks like Tailwind/DaisyUI. It is a more robust and modern solution for embedding self-contained content blocks.</p></li>
</ul>


</section>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/nbrosse\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>